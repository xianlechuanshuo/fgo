<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="css/style.css" rel="stylesheet" />
    <style>
        .servant tr:nth-child(2) td:nth-child(odd) {
            width: 10%;
        }

        .servant tr:nth-child(2) td:nth-child(even) {
            width: 15%;
        }
        .servant tr:nth-child(2){
            text-align: center;
        } 
        .servant tr:nth-child(2)>td:nth-child(2) input{
            width:450px;
        }                     
        .switchCotent{
            display:none;
        }
        .switchCotent.showSwitchContent{
            display:block;
        }
        .switchCotent a{
            margin-left: 1em;
        }
    </style>
</head>
<body id="content" onunload="setStorage()">
    <div id="showSkillsWin" class="showSkills">
        <img src="" alt="" class="skillImg">
        <a id="btnClose" class="close" href="javascript:;">☒</a>
    </div>
    <div id="divServant">
        <table class="servant">
            <tr>
                <td colspan="8">
                    <select id="ddlChooseServant">
                        <option value="-1">|----------------------请选择从者-------------------------|</option>
                    </select>
                    <label for="ckIsMaxGrail">
                        <input type="checkbox" id="ckIsMaxGrail" />圣杯MAX</label>
                    <input type="text" id="txtWord" class="search" list="dlTips" autofocus />
                    <input type="button" id="btnSearch" value="查询" />&nbsp;
                    <a href="javascript:;" id="btnShowMaterials">强化素材</a>&nbsp;
                    <a href="javascript:;" id="btnShowSkills">从者技能</a>&nbsp;
                    <a href="javascript:;" id="btnShowNP">NP获取</a>&nbsp;
                    <a href="javascript:;" id="btnRedirectKazemai">前往理想鄉</a>&nbsp;
                    <a href="javascript:;" id="btnRedirectWiki">前往wiki</a>&nbsp;
                    <datalist id="dlTips"></datalist>
                    <datalist id="dlCardTips"></datalist>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="switchBtn">
                        <label for="rdSave"><input type="radio" id="rdSave" data-divid="divSave" name="switch">存档</label>
                        <label for="rdLoad"><input type="radio" id="rdLoad" data-divid="divLoad" name="switch">读档</label>                     
                    </div>
                </td>
                <td colspan="6">
                    <div class="switchCotent" id="divSave">
                        存档名：<input type="text" id="txtSaveTitle"> <a href="javascript:;" id="btnSave">保存</a>
                    </div>
                    <div class="switchCotent" id="divLoad">
                        <select id="ddlSaveList"></select>
                        <a href="javascript:;" id="btnLoad">加载</a>
                        <a href="javascript:;" id="btnRemove">删除</a>
                    </div>
                </td>
            </tr>            
            <tr>
                <td>阵营</td>
                <td><span id="spanCamp"></span></td>  
                <td>属性</td>
                <td><span id="spanAttributes"></span></td>  
                <td>特性</td>
                <td colspan="3"><span id="spanCharacteristics"></span></td> 
            </tr>           
            <tr>
                <td>等级</td>
                <td>
                    <select id="ddlLvs">
                        <option value="-1">默认</option>
                        <option value="100">Lv.100</option>
                        <option value="99">Lv.99</option>
                        <option value="98">Lv.98</option>
                        <option value="97">Lv.97</option>
                        <option value="96">Lv.96</option>
                        <option value="95">Lv.95</option>
                        <option value="94">Lv.94</option>
                        <option valu+e="93">Lv.93</option>
                        <option value="92">Lv.92</option>
                        <option value="91">Lv.91</option>
                        <option value="90">Lv.90</option>
                        <option value="89">Lv.89</option>
                        <option value="88">Lv.88</option>
                        <option value="87">Lv.87</option>
                        <option value="86">Lv.86</option>
                        <option value="85">Lv.85</option>
                        <option value="84">Lv.84</option>
                        <option value="83">Lv.83</option>
                        <option value="82">Lv.82</option>
                        <option value="81">Lv.81</option>
                        <option value="80">Lv.80</option>
                        <option value="79">Lv.79</option>
                        <option value="78">Lv.78</option>
                        <option value="77">Lv.77</option>
                        <option value="76">Lv.76</option>
                        <option value="75">Lv.75</option>
                        <option value="74">Lv.74</option>
                        <option value="73">Lv.73</option>
                        <option value="72">Lv.72</option>
                        <option value="71">Lv.71</option>
                        <option value="70">Lv.70</option>
                        <option value="69">Lv.69</option>
                        <option value="68">Lv.68</option>
                        <option value="67">Lv.67</option>
                        <option value="66">Lv.66</option>
                        <option value="65">Lv.65</option>
                        <option value="64">Lv.64</option>
                        <option value="63">Lv.63</option>
                        <option value="62">Lv.62</option>
                        <option value="61">Lv.61</option>
                        <option value="60">Lv.60</option>
                        <option value="59">Lv.59</option>
                        <option value="58">Lv.58</option>
                        <option value="57">Lv.57</option>
                        <option value="56">Lv.56</option>
                        <option value="55">Lv.55</option>
                        <option value="54">Lv.54</option>
                        <option value="53">Lv.53</option>
                        <option value="52">Lv.52</option>
                        <option value="51">Lv.51</option>
                        <option value="50">Lv.50</option>
                        <option value="49">Lv.49</option>
                        <option value="48">Lv.48</option>
                        <option value="47">Lv.47</option>
                        <option value="46">Lv.46</option>
                        <option value="45">Lv.45</option>
                        <option value="44">Lv.44</option>
                        <option value="43">Lv.43</option>
                        <option value="42">Lv.42</option>
                        <option value="41">Lv.41</option>
                        <option value="40">Lv.40</option>
                        <option value="39">Lv.39</option>
                        <option value="38">Lv.38</option>
                        <option value="37">Lv.37</option>
                        <option value="36">Lv.36</option>
                        <option value="35">Lv.35</option>
                        <option value="34">Lv.34</option>
                        <option value="33">Lv.33</option>
                        <option value="32">Lv.32</option>
                        <option value="31">Lv.31</option>
                        <option value="30">Lv.30</option>
                        <option value="29">Lv.29</option>
                        <option value="28">Lv.28</option>
                        <option value="27">Lv.27</option>
                        <option value="26">Lv.26</option>
                        <option value="25">Lv.25</option>
                        <option value="24">Lv.24</option>
                        <option value="23">Lv.23</option>
                        <option value="22">Lv.22</option>
                        <option value="21">Lv.21</option>
                        <option value="20">Lv.20</option>
                        <option value="19">Lv.19</option>
                        <option value="18">Lv.18</option>
                        <option value="17">Lv.17</option>
                        <option value="16">Lv.16</option>
                        <option value="15">Lv.15</option>
                        <option value="14">Lv.14</option>
                        <option value="13">Lv.13</option>
                        <option value="12">Lv.12</option>
                        <option value="11">Lv.11</option>
                        <option value="10">Lv.10</option>
                        <option value="9">Lv.9</option>
                        <option value="8">Lv.8</option>
                        <option value="7">Lv.7</option>
                        <option value="6">Lv.6</option>
                        <option value="5">Lv.5</option>
                        <option value="4">Lv.4</option>
                        <option value="3">Lv.3</option>
                        <option value="2">Lv.2</option>
                        <option value="1">Lv.1</option>
                    </select>   
                </td>
                <td>攻击力</td>
                <td>
                    <input type="number" id="txtAttack" />
                </td>
                <td>Hp最大值</td>
                <td>
                    <input type="number" id="txtMaxHp" />
                </td>
                <td>剩余Hp值</td>
                <td>
                    <input type="number" id="txtRemainHp" />
                </td>                

            </tr>
            <tr>
                <td>芙芙Atk</td>
                <td>
                    <input type="number" id="txtFufuAtk" value="0" />
                </td>
                <td>芙芙Hp</td>
                <td>
                    <input type="number" id="txtFufuHp" value="0" />
                </td>

                <td>礼装Atk</td>
                <td>
                    <input type="number" id="txtCardAtk" value="0" list="dlCardTips"/>
                </td>
                <td>礼装Hp</td>
                <td>
                    <input type="number" id="txtCardHp" value="0" />
                </td>
            </tr>            



            <tr>
                <td>卡色</td>
                <td>
                    <select id="ddlCardColor">
                        <option value="0.8">Quick</option>
                        <option value="1">Arts</option>
                        <option value="1.5">Buster</option>
                    </select>
                </td>
                <td>宝具等级</td>
                <td>
                    <select id="ddlTreasureLevel">
                        <option value="tl1">1</option>
                        <option value="tl2">2</option>
                        <option value="tl3">3</option>
                        <option value="tl4">4</option>
                        <option value="tl5">5</option>
                    </select>
                </td>
                <td>宝具倍率(%)</td>
                <td>
                    <input type="number" id="txtTreasureRate" />
                </td>
                <td>OC等级</td>
                <td>
                    <select id="ddlOc">
                        <option value="oc1">1</option>
                        <option value="oc2">2</option>
                        <option value="oc3">3</option>
                        <option value="oc4">4</option>
                        <option value="oc5">5</option>
                    </select>
                    <label for="ckIsSpecialAttack">
                        <input type="checkbox" id="ckIsSpecialAttack" value="1" />特攻
                    </label>
                </td>


            </tr>
            <tr>
                <td>从者职介</td>
                <td>
                    <select id="ddlCareer">
                        <option value="1.00">Saber</option>
                        <option value="0.95">Archer</option>
                        <option value="1.05">Lancer</option>
                        <option value="1.0">Rider</option>
                        <option value="0.9">Caster</option>
                        <option value="0.9">Assassin</option>
                        <option value="1.1">Berserker</option>
                        <option value="1.1">Ruler</option>
                        <option value="1.1">Avenger</option>
                        <option value="1.0">Shielder</option>
                        <option value="1.0">MoonCancer</option>
                        <option value="1.0">Altergo</option>
                        <option value="1.0">Foreigner</option>

                    </select>
                </td>            
                <td>职介克制</td>
                <td>
                    <select id="ddlCareerResist">
                        <option value="1.0">非克制</option>
                        <option value="2.0">普通克制</option>
                        <option value="1.5">狂阶克制</option>
                        <option value="0.5">被克制</option>
                        <option value="1.2">克制Beast III</option>
                        <option value="1.5">Altergo克制下三骑</option>
                    </select>
                </td>
                <td>阵营克制</td>
                <td>
                    <select id="ddlCampResist">
                        <option value="1.1">克制</option>
                        <option value="1.0">非克制</option>
                        <option value="0.9">被克制</option>
                    </select>
                </td>

                <td>宝具特攻(%)</td>
                <td>
                    <input type="number" id="txtTreasureSpecialAttack" value="100" />
                </td>
            </tr>


            <tr>
                <td>宝具威力Buff(%)</td>
                <td>
                    <input type="text" id="txtTreasurePowerBuff" value="0"/>
                </td>
                <td>卡牌Buff(%)</td>
                <td>
                    <input type="text" id="txtCardBuff" value="0" data-value="0" />
                </td>
                <td>攻击力Buff(%)</td>
                <td>
                    <input type="text" id="txtAttackBuff" value="0" />
                </td>
                <td>敌方防御力Buff(%)</td>
                <td>
                    <input type="text" id="txtEnemyDefenceBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>特攻威力Buff(%)</td>
                <td>
                    <input type="number" id="txtSpecialAttackPowerBuff" value="0" />
                </td>
                <td>敌方特防威力Buff(%)</td>
                <td>
                    <input type="number" id="txtSpecialDefencePowerBuff" value="0" />
                </td>
                <td>固定伤害Buff</td>
                <td>
                    <input type="number" id="txtFixedDamageBuff" value="0" />
                </td>
                <td>敌方固定减伤Buff</td>
                <td>
                    <input type="number" id="txtEnemyFixedDamageReductionBuff" value="0" />
                </td>
            </tr>
            <tr>
            </tr>
            <tr>
                <td colspan="8">
                    <input type="button" value="计算" id="btnCalcute" onclick="calc()" />
                </td>
            </tr>
        </table>
    </div>
    <br />

    <div id="divResult" class="resultWrapper">
        <b>结果：<a href="javascript:;" onclick="clearTable(1)">清空</a></b>
        <table id="tbResult" class="result">
            <tr>
                <th>排名</th>
                <th>从者</th>
                <th>等级</th>
                <th>ATK</th>
                <th>剩余HP</th>
                <th>阵营克制</th>
                <th>宝具等级</th>
                <th>宝具倍率</th>
                <th>宝具特攻(oc)</th>
                <th>宝具威力Buff</th>
                <th>卡牌Buff</th>
                <th>攻击力Buff</th>
                <th>特攻威力Buff</th>
                <th>敌方防御力Buff</th>
                <th>伤害最小值</th>
                <th>伤害最大值</th>
                <th>伤害平均值</th>
                <th>&nbsp;</th>
            </tr>
        </table>
    </div>
</body>
</html>
<script src="js/lvs.js"></script>
<script src="js/data.js"></script>
<script src="js/common.js"></script>
<script src="js/base.js"></script>
<script type="text/javascript">
    "use strict";
    /***********************************************************/
    intialData();
    intialServantList();
    loadStorage(true);
    bindSearchTips();

    (function(){
        window.Global_save=[];
        let n=1;//默认选择存档
        let saveStorage=storage.getItem("saveStorage");
        if (saveStorage) {
            saveStorage = JSON.parse(saveStorage);
            
            window.Global_save=saveStorage;
            if(window.Global_save.length>0){
                loadSaveList();
                n=2;//有存档则默认选择读档
            }

        }

        document.querySelector(`.servant .switchCotent:nth-child(${n})`).classList.add("showSwitchContent");

        document.querySelector(`.servant .switchBtn>label:nth-child(${n})>input`).checked=true;

        let switchBtns=document.querySelectorAll(".servant .switchBtn input[type=radio]");
        
        switchBtns.forEach(function(s){
            s.onchange=function(){
                //console.log(this);
                let switchCotents=document.querySelectorAll(".servant .switchCotent");
                switchCotents.forEach(function(sc){
                    sc.classList.remove("showSwitchContent");
                })
                $(this.dataset.divid).classList.add("showSwitchContent");
            }
        })
    })();


    function loadSaveList(){
        updateSaveStorage();
        //清空旧的存档列表信息
        $("ddlSaveList").innerHTML="";
        //重新生成新的存档列表信息
        window.Global_save.forEach(function(s){
            $("ddlSaveList").options.add(new Option(s.title, s.guid));
        })
    }
    function updateSaveStorage(){
        storage.removeItem("saveStorage");
        window.Global_save.sort(compare("guid"));
        storage.setItem("saveStorage", JSON.stringify(window.Global_save));            
    }
    function getMaxGuidId(){
        let max=0;
        window.Global_save.forEach(function(s){
            if(max<s.guid){
                max=s.guid;
            }
        })
        return max+1;
    }
    //保存
    $("btnSave").onclick=function(){
        let id = $("ddlChooseServant").value;
        if (id == "-1") {
            alert("请选择从者");
            return;
        }
        let title=$("txtSaveTitle").value;
        if(title==""){
            alert("存档名不允许为空!");
            return;
        }
        if(window.Global_save.length>0){
            for(let i=0;i<window.Global_save.length;i++){
                let s=window.Global_save[i];
                 if(s.title==title){
                    alert("该存档名已存在，请重命名!");
                    return;
                }               
            }
        }   
        let saveObj={
            guid:getMaxGuidId(),
            id:id,//从者下拉列表value值
            title:title,//存档名
            isMaxGrail:$("ckIsMaxGrail").checked,//是否圣杯MAX
            lv:$("ddlLvs").value,//等级
            atk:$("txtAttack").value,//攻击力
            hp:$("txtMaxHp").value,//Hp最大值
            remainHp:$("txtRemainHp").value,//剩余Hp值
            fufuAtk:$("txtFufuAtk").value,//芙芙Atk
            fufuHp:$("txtFufuHp").value,//芙芙Hp
            cardAtk:$("txtCardAtk").value,//礼装Atk
            cardHp:$("txtCardHp").value,//礼装Hp
            cardColor:$("ddlCardColor").value,//卡色
            treasureLevel:$("ddlTreasureLevel").value,//宝具等级
            treasureRate:$("txtTreasureRate").value,//宝具倍率
            isSpecialAttack:$("ckIsSpecialAttack").checked,//是否特攻
            oc:$("ddlOc").value,//OC等级
            career:getDdlText("ddlCareer"),//从者职介
            careerResist:getDdlText("ddlCareerResist"),//职介克制
            campResist:getDdlText("ddlCampResist"),//阵营克制
            treasureSpecialAttack:$("txtTreasureSpecialAttack").value,//宝具特攻
            treasurePowerBuff:$("txtTreasurePowerBuff").value,//宝具威力Buff
            cardBuff:$("txtCardBuff").value,//卡牌Buff
            attackBuff:$("txtAttackBuff").value,//攻击力Buff
            enemyDefenceBuff:$("txtEnemyDefenceBuff").value,//敌方防御力Buff
            specialAttackPowerBuff:$("txtSpecialAttackPowerBuff").value,//特攻威力Buff
            specialDefencePowerBuff:$("txtSpecialDefencePowerBuff").value,//敌方特防威力BUff
            fixedDamageBuff:$("txtFixedDamageBuff").value,//固定伤害Buff
            enemyFixedDamageReductionBuff:$("txtEnemyFixedDamageReductionBuff").value//敌方固定减伤Buff
        };

        window.Global_save.push(saveObj);
        loadSaveList();
        $("txtSaveTitle").value="";
        alert("存档保存成功!");
    }

    //加载
    $("btnLoad").onclick=function(){
        let guid=$("ddlSaveList").value;
        if(guid==""){
            alert("没东西可加载!");
            return;
        }     
        let currentSaveObj;

        window.Global_save.forEach(function(s){
            if(s.guid==guid){
                currentSaveObj=s;
                //1. forEach中不能使用break，用了会抛出异常
                //2. forEach中使用return 语句不会直接跳出整个方法，阻断下面代码执行
                return;              
            }
        })
        if(currentSaveObj){
            $("txtWord").value="";
            search();
            $("ddlChooseServant").value=currentSaveObj.id;
            $("ddlChooseServant").onchange();

            //加载具体存档信息
            
            //是否圣杯MAX
            $("ckIsMaxGrail").checked=currentSaveObj.isMaxGrail;

            //等级
            $("ddlLvs").value=currentSaveObj.lv;

            //攻击力
            $("txtAttack").value=currentSaveObj.atk;

            //Hp最大值
            $("txtMaxHp").value=currentSaveObj.hp;

            //剩余Hp值
            $("txtRemainHp").value=currentSaveObj.remainHp;

            //芙芙Atk
            $("txtFufuAtk").value=currentSaveObj.fufuAtk;

            //芙芙Hp
            $("txtFufuHp").value=currentSaveObj.fufuHp;

            //礼装Atk
            $("txtCardAtk").value=currentSaveObj.cardAtk;

            //礼装Hp
            $("txtCardHp").value=currentSaveObj.cardHp;

            //卡色
            $("ddlCardColor").value=currentSaveObj.cardColor;

            //宝具等级
            $("ddlTreasureLevel").value=currentSaveObj.treasureLevel;

            //宝具倍率
            $("txtTreasureRate").value=currentSaveObj.treasureRate;

            //是否特攻
            $("ckIsSpecialAttack").checked=currentSaveObj.isSpecialAttack;

            //OC等级
            $("ddlOc").value=currentSaveObj.oc;

            //从者职介
            let careers = $("ddlCareer").options;
            for (let i = 0; i < careers.length; i++) {
                let career = careers[i];
                if (career.text == currentSaveObj.career) {
                    career.selected = true;
                }
            }

            //职介克制
            let careerResists=$("ddlCareerResist").options;
            for (let i = 0; i < careerResists.length; i++) {
                let careerResist = careerResists[i];
                if (careerResist.text == currentSaveObj.careerResist) {
                    careerResist.selected = true;
                }
            }  

            //阵营克制
            let campResists=$("ddlCampResist").options;
            for (let i = 0; i < campResists.length; i++) {
                let campResist = campResists[i];
                if (campResist.text == currentSaveObj.campResist) {
                    campResist.selected = true;
                }
            }     

            //宝具特攻
            $("txtTreasureSpecialAttack").value=currentSaveObj.treasureSpecialAttack;

            //宝具威力Buff
            $("txtTreasurePowerBuff").value=currentSaveObj.treasurePowerBuff;

            //卡牌Buff
            $("txtCardBuff").value=currentSaveObj.cardBuff;

            //攻击力Buff
            $("txtAttackBuff").value=currentSaveObj.attackBuff;

            //敌方防御力Buff
            $("txtEnemyDefenceBuff").value=currentSaveObj.enemyDefenceBuff;

            //特攻威力Buff
            $("txtSpecialAttackPowerBuff").value=currentSaveObj.specialAttackPowerBuff;

            //敌方特防威力Buff
            $("txtSpecialDefencePowerBuff").value=currentSaveObj.specialDefencePowerBuff;

            //固定伤害Buff
            $("txtFixedDamageBuff").value=currentSaveObj.fixedDamageBuff;

            //敌方固定减伤Buff
            $("txtEnemyFixedDamageReductionBuff").value=currentSaveObj.enemyFixedDamageReductionBuff;

        }
    }
 

    //删除
    $("btnRemove").onclick=function(){
        let guid=$("ddlSaveList").value;
        if(guid==""){
            alert("没东西可删!");
            return;
        }
        if(confirm("你确定要删除该存档?")){
            for(let i=0;i<window.Global_save.length;i++){
                let s=window.Global_save[i];
                if(s.guid==guid){
                    //删除指定项
                    window.Global_save.remove(i);
                    //更新缓存
                    loadSaveList();
                    return;
                }
            }         
        }
    }



    //圣杯MAX勾选框改变事件
    $("ckIsMaxGrail").onchange = function () {
        let id = $("ddlChooseServant").value;
        if (id == "-1") {
            alert("请选择从者");
            return;
        }
        let servant = servants[id];
        let check = $("ckIsMaxGrail").checked;
        if (check) {
            $("txtAttack").value = servant.maxAtk;
            $("txtMaxHp").value = servant.maxHp;
            $("txtRemainHp").value = servant.maxHp;
            $("ddlLvs").selectedIndex=1;
        }
        else {
            $("txtAttack").value = servant.atk;
            $("txtMaxHp").value = servant.hp;
            $("txtRemainHp").value = servant.hp;
            $("ddlLvs").selectedIndex=0;
        }
    }
    //下拉从者选中项发生变化事件
    $("ddlChooseServant").onchange = function () {
        $("ckIsSpecialAttack").checked = false;
        $("ckIsMaxGrail").checked = false;
        $("txtFixedDamageBuff").value = 0;
        $("txtCardBuff").dataset.value = 0;
        $("ddlLvs").selectedIndex=0;

        let id = this.value;
        if (id != "-1" && id != "") {
            changeOc();
            bindServantData(id);
        }
    }
    //宝具等级选中项发生变化事件
    $("ddlTreasureLevel").onchange = function () {
        changeTreasureRate();
    };

    //OC等级选中项发生变化事件
    $("ddlOc").onchange = function () {
        changeOc();
    };
    //Hp值变动事件：动态计算双子宝具倍率
    $("txtRemainHp").onchange = function () {
        changeOc();
    }
    $("txtFufuHp").onchange = function () {
        changeOc();
    }
    $("txtCardHp").onchange = function () {
        changeOc();
    }

    //是否特攻
    $("ckIsSpecialAttack").onclick = function () {
        changeOc();
    }

     //等级下拉列表选中项改变事件
    $("ddlLvs").onchange=function(){
        let id=$("ddlChooseServant").value;
        if (id == "-1" || id == "") {
            return;
        }

        let servant = servants[id];  

        let lv=this.value;
        //默认【圣杯MAX】非勾选状态
        $("ckIsMaxGrail").checked=false;

        if(lv!="-1"){//非默认
            // console.log(servant.lvs[lv-1]);
            lv=servant.lvs[lv-1];
            $("txtAttack").value=lv.a;
            $("txtMaxHp").value=lv.h;
            $("txtRemainHp").value=lv.h;
            if(lv.a==servant.maxAtk){
                $("ckIsMaxGrail").checked=true;
                $("ckIsMaxGrail").onchange();
            }
            else if(lv.a==servant.atk){
            	$("ddlLvs").selectedIndex=0;//默认
            }
        }
        else{//默认
            $("txtAttack").value=servant.atk;
            $("txtMaxHp").value=servant.hp;
            $("txtRemainHp").value=servant.hp;   
        }
    }

    /***********************************************************/



    //绑定从者基本信息
    function bindServantData(id) {
        let servant = servants[id];
        //0.阵营
        $("spanCamp").innerHTML = "<a href='javascript:;' data-value='@" + servant.camp + "' onclick='autoClickSearch(this)'>" + servant.camp + "</a>"

        //1.攻击力
        $("txtAttack").value = servant.atk;

        //2.Hp最大值、剩余Hp值
        $("txtMaxHp").value = servant.hp;
        $("txtRemainHp").value = servant.hp;

        //3.宝具倍率
        changeTreasureRate(servant);

        //4.卡色
        document.querySelector("#ddlCardColor option[value='" + servant.cardColor + "']").selected = true;

        //5.从者职介
        let careers = $("ddlCareer").options;
        for (let i = 0; i < careers.length; i++) {
            let career = careers[i];
            if (career.text == servant.career) {
                career.selected = true;
            }
        }

        //6.职介技能
        bindServantCareerSkillInfo(servant);

        //7.宝具副效果补充(oc特攻只能展示一种副效果，如：1001的oc特攻只展示了宝具特攻，副效果的20宝具威力buff没展示，在这进行补充)
        bindTreasureSideEffect(servant);

        //8.属性
        bindAttributes(servant);

        //9.特性
        bindCharacteristics(servant);
    }



    //宝具副效果补充
    function bindTreasureSideEffect(servant) {
        let treasureSideEffect = servant.treasureSideEffect;
        if (treasureSideEffect) {
            let treasurePowerBuff = treasureSideEffect.treasurePowerBuff;//宝具威力buff
            //!isNaN(null)，返回true，需要去掉这种情况
            if (treasurePowerBuff && !isNaN(treasurePowerBuff)) {//单个数值，比如1001宝具的20%宝具威力buff
                $("txtTreasurePowerBuff").value = treasurePowerBuff;
            }

            let cardPowerBuff = treasureSideEffect.cardPowerBuff;//卡牌buff
            if (cardPowerBuff && !isNaN(cardPowerBuff)) {//单个数值，比如剑兰宝具的30%蓝魔放buff
                $("txtCardBuff").value = cardPowerBuff;
            }
        }

    }

    //绑定从者职介信息
    function bindServantCareerSkillInfo(servant) {
        //{ cardColor: 1, cardBuff: 10, fixedDamageBuff: 0, critialPowerBuff: 0 }
        let careerSkill = servant.careerSkill;

        if (careerSkill) {
            let cardColorValue = getFloat("ddlCardColor");
            let cardBuffs = careerSkill.cardBuff;
            if (isNaN(cardBuffs)) {//"12|11"
                cardBuffs = careerSkill.cardBuff.split('|');
            }

            let cardColor = careerSkill.cardColor;
            /************************************卡牌Buff******************************************************/
            //0.8(Quick)，1(Arts)，1.5(Buster)，0(All)，-1(None)，-2(Quick和Arts)，-3(Buster和Quick)
            if ((cardColor == 0.8 || cardColor == 1 || cardColor == 1.5) && cardColor == cardColorValue) {
                $("txtCardBuff").dataset.value = careerSkill.cardBuff;

                $("txtCardBuff").value = careerSkill.cardBuff;
            }
            else if (cardColor == 0) {//215
                $("txtCardBuff").dataset.value = careerSkill.cardBuff;

                $("txtCardBuff").value = careerSkill.cardBuff;
            }
                //Quick和Arts
            else if (cardColor == -2 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                let quickBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = quickBuff;

                $("txtCardBuff").value = quickBuff;
            }
            else if (cardColor == -2 && cardColorValue == 1 && cardBuffs && cardBuffs.length == 2) {
                let artsBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = artsBuff;

                $("txtCardBuff").value = artsBuff;
            }
                //Buster和Quick
            else if (cardColor == -3 && cardColorValue == 1.5 && cardBuffs && cardBuffs.length == 2) {
                let busterBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = busterBuff;

                $("txtCardBuff").value = busterBuff;
            }
            else if (cardColor == -3 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                let quickBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = quickBuff;

                $("txtCardBuff").value = quickBuff;
            }
            /****************************************固定伤害Buff**************************************************/
            if (!isNaN(careerSkill.fixedDamageBuff)) {
                $("txtFixedDamageBuff").value = careerSkill.fixedDamageBuff;
            }
        }

    }


    //计算双子宝具总倍率
    function calTreasureSpecialRemainHpAttackRate() {
        let ocLevel = $("ddlOc").value;
        let id = $("ddlChooseServant").value;
        let servant = servants[id];
        let ocs = servant.oc;

        let tl = $("ddlTreasureLevel").value;
        //原宝具倍率
        let treasureRate = servant.tl[tl];

        //附加倍率《超蓄力威力提升》 (此倍率×自身已损失HP所占百分比,与宝具倍率加算)
        //【※总倍率＝攻击倍率+HP特攻倍率*(1—现在HP/最大HP)】
        let maxHp = getFloat("txtMaxHp");
        let fufuHp = getFloat("txtFufuHp");
        let cardHp = getFloat("txtCardHp");
        let totalHp = maxHp + fufuHp + cardHp;

        let remainHp = getFloat("txtRemainHp");
        //附加倍率
        let additionalRate = ocs[ocLevel] * (1 - remainHp / totalHp);

        //总宝具倍率
        treasureRate += additionalRate;
        //向下取整总宝具倍率
        $("txtTreasureRate").value = Math.floor(treasureRate);

    }
    //计算自爆弓宝具总倍率
    function calTreasureSpecialExplosionAttackRate() {
        let ocLevel = $("ddlOc").value;
        let id = $("ddlChooseServant").value;
        let servant = servants[id];
        let ocs = servant.oc;

        let tl = $("ddlTreasureLevel").value;
        //原宝具倍率
        let treasureRate = servant.tl[tl];

        //总宝具倍率
        treasureRate += ocs[ocLevel];
        //向下取整总宝具倍率
        $("txtTreasureRate").value = Math.floor(treasureRate);
    }

    //OC等级选中项发生变化事件
    function changeOc(servant) {
        if (!servant) {
            let id = $("ddlChooseServant").value;
            servant = servants[id];
        }

        let ocLevel = $("ddlOc").value;
        let isSpecialAttack = $("ckIsSpecialAttack");
        let ocs = servant.oc;
        if (isSpecialAttack.checked) {//是特攻
            if (ocs["type"] == "TreasureSpecialAttack") {//宝具特攻
                $("txtTreasureSpecialAttack").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialRemainHpAttack") {//双子宝具特攻
                calTreasureSpecialRemainHpAttackRate();
            }
            else if (ocs["type"] == "TreasureSpecialExplosionAttack") {//自爆弓特攻
                calTreasureSpecialExplosionAttackRate();
            }
            else if (ocs["type"] == "SpecialAttackPowerBuff") {//杰克女性特攻
                $("txtSpecialAttackPowerBuff").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialCardPowerAttack") {//R金时OC绿魔放
                //由于多了职介技能(被动buff)，这里稍微麻烦点，需要做累加操作。
                let originNum = getTxtAttrFloatNum("txtCardBuff", "value");

                $("txtCardBuff").value = originNum + ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasureSpecialAtkPowerAttack") {//B兰OC加攻
                $("txtAttackBuff").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "TreasurePowerBuff") {//宫本半藏OC宝具威力提升
                $("txtTreasurePowerBuff").value = ocs[ocLevel];
            }
        }
        else {
            $("txtTreasureSpecialAttack").value = 100;
            $("txtSpecialAttackPowerBuff").value = 0;

            $("txtAttackBuff").value = 0;
            $("txtTreasurePowerBuff").value = 0;
            $("ddlOc").selectedIndex = 0;


            //设置回被动卡牌buff
            let originNum = getTxtAttrFloatNum("txtCardBuff", "value");
            $("txtCardBuff").value = originNum;

            //宝具副效果补充
            bindTreasureSideEffect(servant);
        }
    }


    //宝具等级选中项发生变化事件
    function changeTreasureRate(servant) {
        if (!servant) {
            let id = $("ddlChooseServant").value;
            servant = servants[id];
        }

        let tl = $("ddlTreasureLevel").value;
        let treasureRate = servant.tl[tl];

        $("txtTreasureRate").value = treasureRate;
        if (servant.oc.type == "TreasureSpecialRemainHpAttack" && $("ckIsSpecialAttack").checked) {//双子宝具特攻并且勾选了特攻
            calTreasureSpecialRemainHpAttackRate();
        }
        else if (servant.oc.type == "TreasureSpecialExplosionAttack" && $("ckIsSpecialAttack").checked) {//自爆弓特攻
            calTreasureSpecialExplosionAttackRate();
        }
    }
    function intialServantList() {
        // for (let key in servants) {
        //     if (isNaN(key)) {
        //         return;
        //     }
        //     let item = servants[key];
        //     $("ddlChooseServant").options.add(new Option("【" + item.career + "】" + item.name, item.id));
        // }
        servants.forEach(function(servant){
             $("ddlChooseServant").options.add(new Option(`【${servant.career}】${servant.name}`, servant.id));           
        })
    }


    var resultArr = [];
    var rankIndex = 0;
    var guid = 0;
    //计算宝具伤害
    function calc() {
        if ($("ddlChooseServant").value == "-1") {
            alert("请选择从者")
            return;
        }
        guid++;
        //1.攻击力
        let attack = getFloat("txtAttack");

        //2.芙芙Atk
        let fufuAtk = getFloat("txtFufuAtk");

        //3.礼装Atk
        let cardAtk = getFloat("txtCardAtk");

        attack += fufuAtk + cardAtk;

        //4.宝具倍率(%)
        let treasureRate = getFloat("txtTreasureRate") / 100;

        //5.卡色
        let cardColor = getFloat("ddlCardColor");

        //6.职介克制
        let careerResist = getFloat("ddlCareerResist");

        //7.阵营克制
        let campResist = getFloat("ddlCampResist");

        //8.从者职介 
        let career = getFloat("ddlCareer");

        //9.宝具威力Buff(%)
        let treasurePowerBuff = getFloat("txtTreasurePowerBuff") / 100;

        //10.卡牌Buff(%)
        let cardBuff = getFloat("txtCardBuff") / 100;

        //11.攻击力Buff(%)
        let attackBuff = getFloat("txtAttackBuff") / 100;

        //12.敌方防御力Buff(%)
        let enemyDefenceBuff = getFloat("txtEnemyDefenceBuff") / 100;

        //13.特攻威力Buff(%)
        let specialAttackPowerBuff = getFloat("txtSpecialAttackPowerBuff") / 100;

        //14.敌方特防威力Buff(%)
        let specialDefencePowerBuff = getFloat("txtSpecialDefencePowerBuff") / 100;

        //15.固定伤害Buff
        let fixedDamageBuff = getFloat("txtFixedDamageBuff");

        //16.敌方固定减伤Buff
        let enemyFixedDamageReductionBuff = getFloat("txtEnemyFixedDamageReductionBuff");

        //17.宝具特攻(%)     
        let treasureSpecialAttack = getFloat("txtTreasureSpecialAttack") / 100;
        /*
            ATK×攻击补正(0.23)×[宝具倍率×卡牌伤害倍率×(1+卡牌BUFF)]×职阶补正×职阶相性补正×阵营相性补正×乱数补正×(1+攻击力BUFF—敌方防御力BUFF—敌方特防威力BUFF)×(1+特攻威力BUFF+宝具威力BUFF)×宝具特攻
            +(固定伤害BUFF—敌方固定伤害BUFF)
        */
        let resultMin = attack * 0.23 * [treasureRate * cardColor * (1 + cardBuff)] * career * careerResist * campResist * 0.9 * Math.max(0,(1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff))* (1 + specialAttackPowerBuff + treasurePowerBuff) * treasureSpecialAttack + (fixedDamageBuff - enemyFixedDamageReductionBuff);
        resultMin = Math.floor(Math.max(0,resultMin));

        let resultMax = attack * 0.23 * [treasureRate * cardColor * (1 + cardBuff)] * career * careerResist * campResist * 1.1 * Math.max(0,(1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff))* (1 + specialAttackPowerBuff + treasurePowerBuff) * treasureSpecialAttack + (fixedDamageBuff - enemyFixedDamageReductionBuff);
        resultMax = Math.floor(Math.max(0,resultMax));

        let resultAvg = Math.round((resultMin + resultMax) * 1.0 / 2);

        let servantName = getDdlText("ddlChooseServant");

        let maxHp = getFloat("txtMaxHp");
        let fufuHp = getFloat("txtFufuHp");
        let cardHp = getFloat("txtCardHp");
        let totalHp = maxHp + fufuHp + cardHp;

        let remainHp = getFloat("txtRemainHp");

        let tl = getDdlText("ddlTreasureLevel");
        let oc = getDdlText("ddlOc");

        let isMaxGrail = $("ckIsMaxGrail").checked;
        if (isMaxGrail) {
            servantName = "<span class='text-gradient'>" + servantName + "</span>";
        }
        let careerResistClassName = "normal";//非克制
        if (careerResist > 1) {//克制
            careerResistClassName = "weak";
        }
        else if (careerResist < 1) {//被克制
            careerResistClassName = "resist";
        }
        let model = {
            guid: guid,
            servantName: servantName,
            atk: attack,
            hp: totalHp,
            lv:getDdlText("ddlLvs"),
            campResist: getDdlText("ddlCampResist"),
            remainHp: remainHp,
            cardColor: cardColor,
            tl: tl,
            treasureRate: getFloat("txtTreasureRate"),
            treasureSpecialAttack: getFloat("txtTreasureSpecialAttack"),
            oc: oc,
            treasurePowerBuff: getFloat("txtTreasurePowerBuff"),
            cardBuff: getFloat("txtCardBuff"),
            attackBuff: getFloat("txtAttackBuff"),
            specialAttackPowerBuff: getFloat("txtSpecialAttackPowerBuff"),
            enemyDefenceBuff: getFloat("txtEnemyDefenceBuff"),
            min: resultMin,
            max: resultMax,
            avg: resultAvg,
            careerResistClassName: careerResistClassName
        };
        resultArr.push(model);
        showResult();
        reSort();
        resizeParentWindow();
    }
    //从大到小重新排序
    function reSort() {
        resultArr.sort(compare("avg"));
        clearTable();
        for (let i = 0; i < resultArr.length; i++) {
            createTr(resultArr[i]);
        }
    }

    //删除指定行
    function delTr(obj, guid) {
        for (let i = 0; i < resultArr.length; i++) {
            if (resultArr[i].guid == guid) {
                resultArr.remove(i);
            }
        }
        let deleteRow = obj.parentElement.parentElement;
        deleteRow.parentElement.removeChild(deleteRow);
        reSort();
        if (!resultArr || resultArr.length <= 0) {
            hidResult();
        }
        resizeParentWindow();
    }
    //清空table
    function clearTable(obj) {
        if (obj == 1) {//清空resultArr数组
            resultArr.length = 0;
            hidResult();
        }

        rankIndex = 0;
        let tb = $("tbResult");
        let len = tb.rows.length;
        //清空table数据
        for (let i = len - 1; i > 0; i--) {
            tb.deleteRow(i);
        }
        resizeParentWindow();
    }
    //新增Tr
    function createTr(obj) {
        rankIndex++;
        let tb = $("tbResult");
        let newRow = tb.insertRow(-1);
        //1.排名
        newRow.insertCell(-1).innerHTML = rankIndex;

        //2.从者
        newRow.insertCell(-1).innerHTML = obj.servantName;

        //3.等级
        newRow.insertCell(-1).innerHTML = obj.lv;      

        //4.ATK          
        newRow.insertCell(-1).innerHTML = obj.atk;

        //5.剩余HP        
        newRow.insertCell(-1).innerHTML = obj.remainHp;

        //6.阵营克制
        newRow.insertCell(-1).innerHTML = obj.campResist;

        //7.宝具等级      
        newRow.insertCell(-1).innerHTML = obj.tl;
        //8.宝具倍率      
        newRow.insertCell(-1).innerHTML = "<span style='color:" + getColor(obj.cardColor) + ";font-weight:bold;'>" + obj.treasureRate + "</span>"
        //9.宝具特攻(oc)  
        newRow.insertCell(-1).innerHTML = obj.treasureSpecialAttack + "(" + obj.oc + ")";
        //10.宝具威力Buff 
        newRow.insertCell(-1).innerHTML = obj.treasurePowerBuff;
        //11.卡牌Buff     
        newRow.insertCell(-1).innerHTML = obj.cardBuff;
        //12.攻击力Buff   
        newRow.insertCell(-1).innerHTML = obj.attackBuff;
        //13.特攻威力Buff 
        newRow.insertCell(-1).innerHTML = obj.specialAttackPowerBuff;
        //14.特攻威力Buff     
        newRow.insertCell(-1).innerHTML = obj.enemyDefenceBuff;
        //15.宝具伤害最小值    
        let min = newRow.insertCell(-1);
        min.innerHTML = obj.min;
        min.classList.add(obj.careerResistClassName);
        //16.宝具伤害最大值  
        let max = newRow.insertCell(-1);
        max.innerHTML = obj.max;
        max.classList.add(obj.careerResistClassName);
        //17.宝具伤害平均值       
        let avg = newRow.insertCell(-1);
        avg.innerHTML = obj.avg;
        avg.classList.add(obj.careerResistClassName);
        //18.删除操作     
        newRow.insertCell(-1).innerHTML = "<a href='javascript:;' onclick='delTr(this," + obj.guid + ")'>删</a>"
    }
    //获取宝具颜色
    function getColor(num) {
        switch (num) {
            case 1.5:
                return "red";
            case 1:
                return "blue";
            case 0.8:
                return "green";

        }
    }


</script>
